name: Setup Preview Environment

# Run this workflow once to create the initial Cloudflare resources
# After running, copy the D1 database ID from the output and add it as
# the PREVIEW_D1_DATABASE_ID secret in your GitHub repository settings
#
# Required GitHub Secrets:
# - CLOUDFLARE_API_TOKEN: Cloudflare API token with permissions to manage Workers, D1, and R2
# - CLOUDFLARE_ACCOUNT_ID: Your Cloudflare account ID
# - PREVIEW_PAYLOAD_SECRET: Secret key for Payload CMS authentication (generate with: openssl rand -hex 32) (e.g. 1b85f46782e4c1e5fb9b3f8f160de392ca9e0d5350a3deb4f28f0e045690c1861b85f46782e4c1e5fb9b3f8f160de392ca9e0d5350a3deb4f28f0e045690c186)

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  PREVIEW_WORKER_NAME: my-app-preview
  PREVIEW_D1_NAME: my-app-preview
  PREVIEW_R2_NAME: my-app-preview

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Create D1 database
        id: create-d1
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 create ${{ env.PREVIEW_D1_NAME }}
        continue-on-error: true

      - name: Create R2 bucket
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: r2 bucket create ${{ env.PREVIEW_R2_NAME }}
        continue-on-error: true

      - name: Get D1 database ID
        id: get-d1-id
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 list --json

      - name: Extract and update database ID
        run: |
          D1_ID=$(echo '${{ steps.get-d1-id.outputs.command-output }}' | python3 -c "import sys, json; dbs = json.load(sys.stdin); print(next((db['uuid'] for db in dbs if db['name'] == '${{ env.PREVIEW_D1_NAME }}'), ''))")
          echo "Database ID: $D1_ID"
          if [ -z "$D1_ID" ]; then
            echo "Error: Could not find database ID"
            exit 1
          fi
          # Update wrangler.jsonc using Python to only update the preview environment
          python3 << EOF
          import json, re
          with open('wrangler.jsonc', 'r') as f:
              content = f.read()
          # Remove comments for JSON parsing
          json_content = re.sub(r'//.*?\n|/\*.*?\*/', '', content, flags=re.DOTALL)
          # Parse and update
          config = json.loads(json_content)
          if 'env' in config and 'preview' in config['env']:
              for db in config['env']['preview']['d1_databases']:
                  db['database_id'] = '$D1_ID'
          # Write back (preserve original format with comments)
          content = content.replace('"database_id": "DATABASE_ID",', '"database_id": "$D1_ID",', 1)
          content = content.replace('"database_id": "DATABASE_ID"', '"database_id": "$D1_ID"')
          with open('wrangler.jsonc', 'w') as f:
              f.write(content)
          EOF
          echo "Updated wrangler.jsonc preview section:"
          cat wrangler.jsonc | grep -A 10 '"preview"'

      - name: Deploy application
        run: CLOUDFLARE_ENV=preview pnpm run deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PAYLOAD_SECRET: ${{ secrets.PREVIEW_PAYLOAD_SECRET }}
          NODE_ENV: production # just tells Next.js to do a production build (optimized), but doesn't affect the Cloudflare environment

      - name: Setup complete
        run: |
          echo "=========================================="
          echo "Preview environment setup complete!"
          echo "=========================================="
          echo ""
          echo "Next steps:"
          echo "1. Copy the 'database_id' from the D1 info output above"
          echo "2. Add it as PREVIEW_D1_DATABASE_ID secret in GitHub"
          echo "   Settings > Secrets and variables > Actions > New repository secret"
          echo ""
          echo "Resources created:"
          echo "- D1 database: ${{ env.PREVIEW_D1_NAME }}"
          echo "- R2 bucket: ${{ env.PREVIEW_R2_NAME }}"
          echo "- Worker secret: PAYLOAD_SECRET"
          echo "=========================================="
